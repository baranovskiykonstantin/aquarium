# Контроллер для аквариума

## Описание
Контроллер предназначен для управления освещением и температурой воды аквариума.<br>
Конструктивно он представляет собой печатную плату с дисплеем, к которой подключается питание (~220 В, =5В), емкостный сенсор для переключения режимов отображения, нагреватель и лампа.<br>
Для получения низковольтного напряжения питания (=5В) используется плата от зарядного устройства мобильного телефона.<br>
Емкостный сенсор выполнен из прямоугольного куска алюминиевого скотча размером 10х50 мм и наклеен с внутренней стороны крышки аквариума над дисплеем. С платой соединяется небольшим отрезком провода.<br> 
Дисплей работает в двух режимах:<br>
* отображение времени<br>
* отображение температуры воды<br>

Время отображается в формате 24 часов.<br>
Температура отображается в диапазоне `-55...125`°C. При отключенном датчике отображается `" -- "`.<br>
Нагреватель изготовлен самостоятельно из четырех керамических резисторов 470 Ом 5Вт. Они соединяются последовательно, помещаются в пробирку, засыпаются просушенными песком и закрываются силиконовым герметиком. Мощность такого нагревателя составляет 25Вт.<br>
Освещение выполнено из 10 светодиодов мощностью 1Вт и соответствующего драйвера светодиодов.<br>
Все элементы смонтированы на крышке изготовленной из оргстекла.

## Схема
![schematic](https://raw.github.com/baranovskiykonstantin/aquarium/master/aquarium-schematic.png)

## Печатная плата
![pcb-top](https://raw.github.com/baranovskiykonstantin/aquarium/master/aquarium-pcb-top.png)
![pcb-bottom](https://raw.github.com/baranovskiykonstantin/aquarium/master/aquarium-pcb-bottom.png)

Топология печатной платы разведена не полностью, нужно дополнительно установить две перемычки (на изображении указаны красными линиями).<br>
При расположении элементов дисплей по ошибке был установлен "вверх ногами" (повернут на 180°), но так как его конструкция симметрична и десятичные точки не задействованы, то особой проблемы это не составляет. В участке программы, отвечающего за отображение информации, данная особенность учтена.<br>
Для монтажа дисплея на плату нужно отогнуть выводы под прямым углом наружу.

## Настройка
Настройка параметров работы выполняется через интерфейс UART (разъем XT5).<br>
Параметры соединения: `9600 8-N-1`.

Передача параметров выполняется с помощью команд. Все команды (кроме команды `status`) возвращают в качестве 
ответа `OK` или `ERROR` в случае успеха или неудачи соответственно. Каждая команда должна завершаться символом новой 
строки `\n`, или возврата каретки и новой строки `\r\n`. Регистр символов команды значения не имеет.

Параметры термостата и таймера освещения хранятся в энергонезависимой памяти микроконтроллера. 
Параметры даты и времени - в регистрах микросхемы часов реального времени.

### Команда `status`
Текущее состояние контроллера.

Формат:

`status`

Ответ:

`01.01.2016 Friday 13:29:59`<br>
`Temp: 25`<br>
`Heat: OFF (24-25)`<br>
`Light: ON (10:00:00-20:00:00)`

### Команда `date`
Установка даты.

Формат:

`date DD.MM.YY W`

Параметры:<br>
* `DD` - день месяца (01-31)
* `MM` - месяц (01-12)
* `YY` - год (00-99)
* `W` - день недели (1 - понедельник, 7 - воскресенье)

Ответ:

`OK` или `ERROR`

### Команда `time`
Установка времени.

Формат:

`time HH:MM:SS`

Параметры:<br>
* `HH` - часы (00-23)
* `MM` - минуты (00-59)
* `SS` - секунды (00-59)

Ответ:

`OK` или `ERROR`

### Команда `heat`
Параметры термостата.

Формат:

`heat LL-HH`

Параметры:<br>
* `LL` - нижний предел температуры воды, ниже которого будет включен нагреватель (00-99)
* `HH` - верхний предел температуры воды, выше которого будет выключен нагреватель (00-99)

Ответ:

`OK` или `ERROR`

### Команда `light`
Параметры таймера освещения.

Формат:

`light H1:M1:S1-H2:M2:S2`

Параметры:<br>
* `H1:M1:S1` - время включения освещения (00:00:00-23:59:59)
* `H2:M2:S2` - время выключения освещения (00:00:00-23:59:59)

Ответ:

`OK` или `ERROR`
