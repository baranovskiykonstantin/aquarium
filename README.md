# Контроллер для аквариума

## Описание
Контроллер предназначен для управления освещением и температурой воды аквариума.<br>

![schematic](https://raw.github.com/baranovskiykonstantin/aquarium/master/aqua.png)

Конструктивно он состоит из нескольких модулей (платы контроллера, блока питания, Bluetooth модуля), 
емкостного сенсора для переключения режимов отображения, датчика температуры, нагревателя и светодиодов для освещения.<br>
Модули контроллера и блока питания спроектированы в САПР KiCAD и изготовляются самостоятельно.<br>
Модуль Bluetooth используется готовый - HC-05.<br>
Емкостный сенсор выполнен из прямоугольного отрезка алюминиевого скотча размером 10х50 мм и наклеен с внутренней стороны крышки аквариума над дисплеем. 
С платой соединяется небольшим отрезком провода.<br>
В качестве датчика температуры применён интегральный датчик DS18B20 в герметичном исполнении.<br>
Нагреватель изготовляется самостоятельно из четырех керамических резисторов 470 Ом 5Вт. 
Они соединяются последовательно, помещаются в пробирку, засыпаются просушенными и просеянным песком, закрываются силиконовым герметиком. 
Мощность такого нагревателя составляет 25Вт.<br>
Освещение выполнено из 4 светодиодов мощностью 1Вт, соединённых последовательно.<br>
Все элементы смонтированы в крышке изготовленной из оргстекла.

## Схема
### Контроллер
![schematic](https://raw.github.com/baranovskiykonstantin/aquarium/master/aquarium-schematic.png)

### Блок питания
![schematic](https://raw.github.com/baranovskiykonstantin/aquarium/master/power-schematic.png)

Дисплей работает в двух режимах:<br>
* отображение времени<br>
* отображение температуры воды<br>

Время отображается в формате 24 часов.<br>
Температура отображается в диапазоне `-55...125`°C. При отключенном датчике отображается `" -- "`.<br>

## Печатные платы
### Верх
![pcb-top](https://raw.github.com/baranovskiykonstantin/aquarium/master/aquarium-pcb-top.png)

### Низ
![pcb-bottom](https://raw.github.com/baranovskiykonstantin/aquarium/master/aquarium-pcb-bottom.png)

Для монтажа дисплея на плату нужно отогнуть выводы под прямым углом наружу.

## Настройка
Настройка параметров работы выполняется через Bluetooth.<br>
Параметры соединения: `9600 8-N-1`.

Передача параметров выполняется с помощью команд. Все команды (кроме команды `status`) возвращают в качестве 
ответа `OK` или `ERROR` в случае успеха или неудачи соответственно. Каждая команда должна завершаться символом новой 
строки `\n`, или возврата каретки и новой строки `\r\n`. Если переданное значение параметра превысит допустимое 
значение, будет установлено максимально позволенное.

Параметры термостата и таймера освещения хранятся в энергонезависимой памяти микроконтроллера. 
Параметры даты и времени - в регистрах микросхемы часов реального времени.

### Команда `status`
Вывод текущего состояния контроллера.

Формат:

`status`

Ответ:

`01.01.2017 Friday 13:29:59 (-3 sec at 12:00:00)`<br>
`Temp: 22`<br>
`Heat: OFF auto (20-22)`<br>
`Light: ON manual (10:00:00-20:00:00) 50%`<br>
`Display: time`

Описание:

Строка 1: текущие дата, день недели, время и информация о суточной коррекции времени;<br>
Строка 2: текущая температуры воды (°C);<br>
Строка 3: состояние термостата:<br>
* `ON` - нагреватель включен, `OFF` - нагреватель выключен
* `auto` - автоматический режим работы, `manual` - ручной режим работы
* в скобка указан диапазон температуры, поддерживаемый в автоматическом режиме<br>

Строка 4: состояние освещения:<br>
* `ON` - свет включен, `OFF` - свет выключен
* `auto` - автоматический режим работы, `manual` - ручной режим работы
* в скобка указан период времени, в течении которого свет включен в автоматическом режиме
* в конце указан уровень яркости в процентах

Строка 5: режим работы дисплея (`time` - отображение времени, `temp` - отображение температуры)

### Команда `date`
Установка параметров даты.

Формат:

`date DD.MM.YY W`

Параметры:<br>
* `DD` - день месяца (01-31)
* `MM` - месяц (01-12)
* `YY` - год (00-99)
* `W` - день недели (1 - понедельник ... 7 - воскресенье)

Ответ:

`OK` или `ERROR`

### Команда `time`
Установка параметров времени.

Формат 1:

`time HH:MM:SS`

Параметры:<br>
* `HH` - часы (00-23)
* `MM` - минуты (00-59)
* `SS` - секунды (00-59)

Формат 2:

`time +CC`<br>
`time -CC`

Параметры:<br>
* `+` или `-` - прибавить или отнять поправку времени
* `CC` - секунды коррекции времени (00-59)

Формат 3:

`time HH:MM:SS +CC`
`time HH:MM:SS -CC`

Параметры:<br>
* `HH` - часы (00-23)
* `MM` - минуты (00-59)
* `SS` - секунды (00-59)
* `+` или `-` - прибавить или отнять поправку времени
* `CC` - секунды коррекции времени (00-59)

Ответ:

`OK` или `ERROR`

### Команда `heat`
Параметры термостата.

Формат 1:

`heat LL-HH`

Параметры:<br>
* `LL` - нижний предел температуры воды, ниже которого будет включен нагреватель в автоматическом режиме (00-99)
* `HH` - верхний предел температуры воды, выше которого будет выключен нагреватель в автоматическом режиме (00-99)

Формат 2:

`heat on`<br>
`heat off`<br>
`heat auto`<br>

Параметры:<br>
* `on` - перейти в ручной режим работы и включить нагреватель
* `off` - перейти в ручной режим работы и выключить нагреватель
* `auto` - перейти в автоматический режим работы

Ответ:

`OK` или `ERROR`

### Команда `light`
Параметры таймера освещения.

Формат 1:

`light H1:M1:S1-H2:M2:S2`

Параметры:<br>
* `H1:M1:S1` - время включения освещения в автоматическом режиме (00:00:00-23:59:59)
* `H2:M2:S2` - время выключения освещения в автоматическом режиме (00:00:00-23:59:59)

Формат 2:

`light on`<br>
`light off`<br>
`light auto`<br>

Параметры:<br>
* `on` - перейти в ручной режим работы и включить свет
* `off` - перейти в ручной режим работы и выключить свет
* `auto` - перейти в автоматический режим работы

Формат 3:

`light level XXX`

Параметры:<br>
* `XXX` - уровень яркости освещения (000-100)

Формат 4:

`light H1:M1:S1-H2:M2:S2 XXX`

Параметры:<br>
* `H1:M1:S1` - время включения освещения в автоматическом режиме (00:00:00-23:59:59)
* `H2:M2:S2` - время выключения освещения в автоматическом режиме (00:00:00-23:59:59)
* `XXX` - уровень яркости освещения (000-100)

Ответ:

`OK` или `ERROR`

### Команда `display`
Параметры отображения информации на дисплее.

Формат:

`display time`<br>
`display temp`

Параметры:<br>
* `time` - отображать на дисплее текущее время
* `temp` - отображать на дисплее текущую температуру воды

Ответ:

`OK` или `ERROR`
